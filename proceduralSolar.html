<!DOCTYPE html>
<html lang="en">
    <head>
	<meta charset="utf-8">
	<title>My first three.js app</title>
	<style>
	 body { margin: 0; }
	 canvas { width: 100%; height: 90% }
	 #toolbar { color: white; position: absolute; }
	 #toolbar a { color: lightgrey; }
	 #toolbar a:hover { text-decoration: none; }
	</style>
    </head>
    <body>
	<p id="toolbar">
	    <a href="https://threejs.org/docs/index.html#manual/en/introduction/Creating-a-scene">Documentation</a>
	    <a href="mailto:adrien.peytavie@liris.cnrs.fr">adrien.peytavie@liris.cnrs.fr</a>
	</p>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/84/three.js"></script>
	<script src="OrbitControls.js"></script>
	<script src='perlin.js'></script>
	<script>
	//Class qui compose la galaxy
	class SolarSystem {
	 	nbPlanets;
		solarSystem;
		positionSolarSys;
		sun;

		planets = [];
		addPlanet(){
			var p = new Planet(Math.random()*(this.nbPlanets+3)+5,Math.random(),this.sun,this.solarSystem,Math.random()*(0.1 + 0.1)- 0.1);
			this.planets.push(p);
		}



		constructor(positionSolarSys,nbPlanets) {
			this.solarSystem = new THREE.Object3D();
			this.solarSystem.position.x = positionSolarSys.x;
			this.solarSystem.position.y = positionSolarSys.y;
		    this.positionSolarSys = positionSolarSys;
		    this.nbPlanets = nbPlanets;
		 	scene.add(this.solarSystem);

		 	var ball = new THREE.SphereGeometry(Math.random()+0.8 , 32, 32);
			var sunMaterial = new THREE.MeshBasicMaterial( { color: 0xff4500 } );
			this.sun = new THREE.Mesh(ball, sunMaterial);
			this.solarSystem.add(this.sun);

			for(var i = 0;i<nbPlanets; i++){
				this.addPlanet();
			}
		}


		rotatePlanets(){
			for(var i = 0;i<this.planets.length;i++){
	     		this.planets[i].rotate();
	     	} 
		}

		

	}

	class Planet{
		centerObj;
		distance;
		angle = 0;
		rayon;
		speed;
		planet;

		constructor(distance,rayon,centerObj,solarSystem,speed){
			var ball = new THREE.SphereGeometry(rayon, 32, 32);
			var planetMaterial = new THREE.MeshBasicMaterial();
			planetMaterial.color=new THREE.Color( Math.random(), Math.random(), Math.random() );
			this.planet = new THREE.Mesh(ball, planetMaterial);
			this.distance = distance;
			this.centerObj = centerObj;
			this.speed = speed;
			this.rayon = rayon;
			solarSystem.add(this.planet);
			this.rotate()
		}

		rotate () {
			this.angle += this.speed;
			if(this.centerObj != null){
				this.planet.position.x = this.distance*Math.cos(this.angle) + this.centerObj.position.x;
	    		this.planet.position.y = this.distance*Math.sin(this.angle) + this.centerObj.position.y;
			}else{
				this.planet.position.x = this.distance*Math.cos(this.angle);
	    		this.planet.position.y = this.distance*Math.sin(this.angle);
			}
	 	}
	 	getRandomColor() {
		  var letters = '0123456789ABCDEF';
		  var color = '0x';
		  for (var i = 0; i < 6; i++) {
		    color += letters[Math.floor(Math.random() * 16)];
		  }
		  return color;
		}
	}


	 
	class Galaxy{
		controls;
		listSolarS = []
		constructor(controls){
			var width = Math.floor(window.innerWidth/10); 
			var height = Math.floor(window.innerHeight/10);

			var seed = Math.floor(Math.random()*100000);
			console.log(seed + " | " +noise.simplex2(1000/100,1000/100));
			noise.seed(seed);
			this.controls = controls;


			//this.recurciveGeneration(-window.innerWidth/2,-window.innerHeight/2);
			
			
			for(var x = -width/2;x<width/2;x=x+5){
				for(var y = -height/2;y<height/2;y=y+5){
					if(this.checkDistance(new THREE.Vector3(x,y,0))){

						if(Math.abs(noise.simplex2(x/10,y/10))>0.7){
							this.listSolarS.push(new SolarSystem(new THREE.Vector3(x,y,0),Math.floor(Math.random()*10+1)));
						}
						
					}
				}
			 
			}
		}

		checkDistance(positionNewSolarSys){
			//TODO: Vector3 check if there is a solarsystem on this case 

			for(var i=0;i<this.listSolarS.length;i++){
				var distance = positionNewSolarSys.distanceTo(this.listSolarS[i].positionSolarSys);
				
				if (Math.abs(distance)<30){
					return false;
				}
			}
			return true;

		}

		galaxyRotation(){
			for(var i = 0;i<this.listSolarS.length;i++){
	     		this.listSolarS[i].rotatePlanets();
	     	} 
		}


		recurciveGeneration(x,y){
			if(this.checkDistance(new THREE.Vector3(x,y,0))){
				this.listSolarS.push(new SolarSystem(new THREE.Vector3(x*2,y*2,0),Math.floor(Math.random()*10+1)));
			}
			if(x>window.innerWidth){
				if(y<window.innerHeight){
					this.recurciveGeneration(window.innerWidth,y*2+Math.random()*30);
				}
			}else{
				if(y<window.innerHeight){
					this.recurciveGeneration(x*2+Math.random()*30,y*2+Math.random()*30);
				}else{
					this.recurciveGeneration(x*2+Math.random()*30,window.innerHeight);
				}
			}
			
		}


	}




	 // Initialisation of the scene / camera / renderer
	 var scene = new THREE.Scene();
	 var camera = new THREE.PerspectiveCamera( 75, window.innerWidth / window.innerHeight, 0.1, 1000 );
	 var renderer = new THREE.WebGLRenderer();
	 renderer.setSize( window.innerWidth, window.innerHeight );
	 renderer.shadowMap.enabled = true;
	 document.body.appendChild( renderer.domElement );
	 camera.position.z = 60;
	 
	 

	//Gestion des mouvements de la camera
	var controls = new THREE.OrbitControls (camera, renderer.domElement);

	controls.noKeys = true;
	controls.noRotate = true;
	controls.update();

	//initialisation de la galaxy
	var galaxy = new Galaxy(controls);


	//TODO: Génération procédural
	console.log(controls.center); //Affiche le centre de la camera



	 // This is executed for each frames
	 function render() {
	     requestAnimationFrame( render );
	     // Animation code goes here
	     renderer.render( scene, camera );

	     galaxy.galaxyRotation();
	     //Update de la Camera
	     controls.update();

	     
	 }





	 render();





	 
	</script>
    </body>
</html>